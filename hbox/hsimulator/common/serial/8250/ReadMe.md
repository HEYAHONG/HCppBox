# 说明

本目录用于辅助实现8250串口及其兼容型号（如16550）的辅助代码。

最小可只实现写THR，此时可用于调试信息打印。

 本目录的组件与内核的交互方式为MMIO，即用户需要先在内存地址空间中划分部分地址用于本组件，主设备通过访问划分的内存地址来访问设备。

# 使用

使用8250串口及其兼容型号（如16550）作为模拟器外设的步骤如下：

- 使用io操作回调函数进行初始化,相关函数：`hs_common_serial_8250_init`。
- 在主设备（如CPU）的io操作回调中调用总线相关函数，相关函数：`hs_common_serial_8250_bus_write`、`hs_common_serial_8250_bus_read`、`hs_common_serial_8250_bus_write32`、`hs_common_serial_8250_bus_read32`、`hs_common_serial_8250_bus_tick`。
- 在io操作回调中实现具体的逻辑功能，相关函数为前几条未提到的其余函数。

## io操作回调

本目录的代码未具体实现实际功能，只是提供了相应的接口。

用户需要实现io操作回调以实现具体功能。

# 寄存器

8250串口及其兼容型号（如16550）包含以下12个寄存器：

- RBR:接收缓冲寄存器
- THR:发送保持寄存器
- IER:中断使能寄存器
- IIR:中断指示寄存器
- FCR:FIFO控制寄存器
- LCR:线路控制寄存器
- MCR:Modem控制寄存器
- LSR:线路状态寄存器
- MSR:Modem 状态寄存器
- SCR:Scratch寄存器
- DLL:除数低字节寄存器
- DLM:除数高字节寄存器

对于无需32位对齐访问的系统而言，以上寄存器均是8位的。

对于需要32位对齐访问的系统而言，以上寄存器均是32位的（低8位有效）。

寄存器的地址共8个，当无需32位对齐访问时，地址范围0到7,当需要32为对齐访问时，地址范围为0到0x1C。

## RBR

接收缓冲寄存器。用于缓冲8位数据。只可读。

## THR

发送保持寄存器。用于缓冲8位数据。只可写。

## IER

| 位    | 说明                              |
| ----- | --------------------------------- |
| [4 7] | 保留                              |
| 3     | EDSSI,Modem状态中断使能。1=使能。 |
| 2     | ELSI,接收器线状态中断使能。1=使能 |
| 1     | ETBEI,发送空使能。1=使能。        |
| 0     | ERBFI,接收满使能。1=使能。        |

## IIR

| 位    | 说明                                                         |
| ----- | ------------------------------------------------------------ |
| [6 7] | FIFOEN。非FIFO模式先始终为0                                  |
| [4 5] | 保留                                                         |
| [1 3] | INTID。指示中断ID。3=接收器线状态中断，2=接收数据可用，6=字符超时，1=发送空中断，0=Modem状态中断 |
| 0     | INTPEND。是否有中断正在等待。1=没有中断在等待。              |

## FCR

注意：此寄存器并不一定可用。

| 位    | 说明                                                   |
| ----- | ------------------------------------------------------ |
| [6 7] | RCVR FIFO触发级别。0=1字节，1=4字节，2=8字节，3=14字节 |
| [4 5] | 保留                                                   |
| 3     | DMA模式选择。                                          |
| 2     | XMIT FIFO复位。1=复位                                  |
| 1     | RCVR FIFO复位。1=复位                                  |
| 0     | FIFOEN。1=使能FIFO                                     |

## LCR

| 位    | 说明                                                         |
| ----- | ------------------------------------------------------------ |
| 7     | DLAB。除数访问位。1=访问除数寄存器，0=访问RBR、THR、IER等寄存器 |
| 6     | Set Break。1=使能Break条件                                   |
| 5     | Stick Parity 。1=当使能校验(PEN)时,校验由EPS的值(校验值与其值相反)决定为固定1或者0. |
| 4     | EPS 。检验选择。当Stick Parity为0且使能校验时，1=Even，0=Odd |
| 3     | PEN。校验使能。1=使能校验。                                  |
| 2     | STB。停止位。0=1停止位。1=默认2停止位，当字长为5时为1.5停止位。 |
| [0 1] | WLS。字长选择。0=5位，1=6位，2=7位，3=8位。                  |

## MCR

| 位    | 说明              |
| ----- | ----------------- |
| [5 7] | 保留位            |
| 4     | Loop。1=使能回环  |
| 3     | Out2 。1=拉低Out2 |
| 2     | Out1。1=拉低Out1  |
| 1     | RTS。1=拉低RTSN。 |
| 0     | DTR。1=拉低DTRN。 |

## LSR

| 位   | 说明                                                         |
| ---- | ------------------------------------------------------------ |
| 7    | Error in RCVR FIFO。                                         |
| 6    | TE。Transmitter Empty。此标志表示THR与发送shift寄存器均为空。1=空。 |
| 5    | THRE。Transmitter Holding Register Empty。1=空               |
| 4    | BI。Break Interrupt。                                        |
| 3    | FE。Framing Error。                                          |
| 2    | PE。Framing Error。                                          |
| 1    | OE。Overrun Error。                                          |
| 0    | DR。Data Ready。此标志表示有数据可接收。1=有数据可接收。     |

## MSR

| 位   | 说明                               |
| ---- | ---------------------------------- |
| 7    | DCD,由外部输入直接驱动。           |
| 6    | RI,由外部输入直接驱动。            |
| 5    | DSR,由外部输入直接驱动。           |
| 4    | CTS,由外部输入直接驱动。           |
| 3    | DDCD,DCD自上次读取已改变。         |
| 2    | TERI，RI自上次读取已改变(低到高)。 |
| 1    | DDSR，DSR自上次读取已改变。        |
| 0    | DCTS，CTS自上次读取已改变。        |

## SCR

临时数据寄存器，用于存放8位临时数据。

## DLL

除数低字节。

与除数高字节共同构成除数。

波特率=时钟频率/（16×除数）

## DLM

除数高字节。

与除数低字节共同构成除数。

波特率=时钟频率/（16×除数）

# 相关链接

## 硬件数据手册

- [INS8250](https://www.alldatasheetcn.com/datasheet-pdf/view/89961/NSC/INS8250.html)
- [PC16550D](https://www.alldatasheetcn.com/datasheet-pdf/view/839262/TI1/PC16550D.html)

