# 说明

hbox意为HYH的工具箱。

实现一些在开发过程中的常用函数及相关结构。

# 宏定义

## 外部控制

此类宏定义通常是通过编译器命令行参数传递的,也可能是编译器预定义的。

不同的宏定义将触发不同的行为。

|     宏定义     |         说明          |                             备注                             |
| :------------: | :-------------------: | :----------------------------------------------------------: |
| `__RTTHREAD__` | 处于RT-Thread操作系统 |                     RT-Thread 4.0.3+有效                     |
|    `WIN32`     |     处于windows中     |                                                              |
|   `__unix__`   |    处于(类)unix中     | 若处于linux中，可使用`__linux__` 判断。在(类)unix中将使用pthread及其相关库（有些可能需要手动启用）。 |

# 组件

## hcompiler

主要提供一些编译器相关特性的宏定义。

|         宏定义         |      说明      |                             备注                             |
| :--------------------: | :------------: | :----------------------------------------------------------: |
|        `__ASM`         |      汇编      |                                                              |
|       `__INLINE`       |      内联      |                                                              |
|   `__STATIC_INLINE`    |    静态内联    |                                                              |
| `__STATIC_FORCEINLINE` |  静态强制内联  |                                                              |
|     `__NO_RETURN`      |     无返回     |                                                              |
|        `__USED`        |  标记已被使用  |                                                              |
|        `__WEAK`        |     弱定义     | 一般用于库函数编写。注意:在gcc中必须指定`-Wl,--whole-archive`才能确保库的弱定义一定生效 |
|       `__PACKED`       |  取消对齐优化  |                                                              |
|      `__ALIGNED`       |    对齐设置    |                                                              |
|      `__RESTRICT`      | restrict限定符 |                                                              |
|      `__NO_INIT`       |  不进行初始化  | 通常用于支持SRAM在复位时不复位的单片机使用。可减少异常复位带来的数据损失。 |
|       `__ALIAS`        |      别名      |                                                              |
|      `__SECTION`       |     设置节     |                     通常配合链接脚本使用                     |

## hdefaults

本组件主要提供一些定义及函数。本工具箱的可移植部分通常在本组件中进行。

|                        函数                         |      说明      |            备注            |
| :-------------------------------------------------: | :------------: | :------------------------: |
| `void * hdefaults_malloc(size_t nBytes,void *usr);` |  默认内存分配  |                            |
|     `void hdefaults_free(void *ptr,void *usr);`     |  默认内存释放  |                            |
|      `void  hdefaults_mutex_lock(void *usr);`       | 默认互斥锁加锁 | 通常在实现时使用临界区实现 |
|     `void  hdefaults_mutex_unlock(void *usr);`      | 默认互斥锁解锁 | 通常在实现时使用临界区实现 |

##  heventloop

本组件用于辅助实现事件循环功能，通常用于将一些事件发送到其它线程执行。

## heventslots

本组件通常用于实现一般回调函数功能。本组件主要定义以下语义:

- 信号:调用回调函数的参数。
- 槽:回调函数
- 发送信号:使用信号作为参数依次调用回调函数。

## heventchain

本组件通常用于实现Hook回调函数功能。本组件中回调函数是链式的,当排在前面的回调函数成功处理后将不再向后传递,如同windows的钩子一样，优先级较高的钩子可截断某些操作。

## hwatchdog

本组件通常用于辅助实现看门狗,包括软件实现的看门狗及硬件看门狗喂狗。

## hmemoryheap

本组件主要用于实现一个简易内存堆。在操作系统不提供动态内存分配时使用。 

可管理的内存参数如下:

|          项目          |               值(字节)               |               经典值（对齐为4,32位系统）               |
| :--------------------- | :----------------------------: | ---------------------- |
| 可管理的最大内存字节数 | `2^31 - HMEMORYHEAP_ALIGNED_SIZE` | 0x7FFF FFFC Bytes |
| 可管理的最小内存字节数(无法分配任何内存，仅供创建堆) | `sizeof(hmemoryheap_pool_block_t)+sizeof(hmemoryheap_pool_t)` | 32 Bytes |
| 推荐的最小内存字节数 |  | 256 Bytes |
| 每分配一个指针额外消耗的最小内存 | `sizeof(hmemoryheap_pool_block_t)` | 4 Bytes |
| 每分配一个指针额外消耗的最大内存 | `sizeof(hmemoryheap_pool_block_t)*2+（HMEMORYHEAP_ALIGNED_SIZE-1）` | 11 Bytes |

可配置的宏定义如下:

|             宏定义              |                             说明                             |            备注             |
| :-----------------------------: | :----------------------------------------------------------: | :-------------------------: |
|   `HMEMORYHEAP_ALIGNED_SIZE`    |                  对齐大小。默认为指针大小。                  | 需根据对应架构的要求修改。  |
|   `HMEMORYHEAP_MAGIC_NUMBER`    |         魔数，用作标记是否初始化。默认为0xcccc55aa。         |                             |
|     `HMEMORYHEAP_PTR_SIZE`      |               指针大小。默认不定义(默认为4)。                | 对于64位系统一定要指定为8。 |
| `HMEMORYHEAP_DEFAULT_POOL_SIZE` |            默认堆大小。至少256字节。默认不定义。             |                             |
|       `USING_HMEMORYHEAP`       | 启用默认堆(默认256字节)并将其作为本工具箱默认内存分配函数。默认不定义 |                             |

## hobject

本组件主要用于实现一些基于C的对象的相关操作。





