# 说明

此目录用于对C运行库的部分函数进行包装。

# 目录说明

- [wrapper](wrapper)：包装C运行库库函数
- [hlibc](hlibc):用于扩展某些环境下（如无操作系统环境）的libc

# 外部配置的宏定义

| 宏定义                          | 说明                 | 备注                                                         |
| ------------------------------- | -------------------- | ------------------------------------------------------------ |
| `HDEFAULTS_LIBC_OPTIMIZE_LEVEL` | C运行库优化级别。    | 默认优化级别为0（直接包装原C运行库的函数）。无操作系统时应当定义为1. |
| `HDEFAULTS_LIBC_TINY`           | 精简C运行库包装      | 用于减小代码体积。注意:此选项将关闭libc包装的初始化与循环调用，可能影响部分功能，此时用户需要手动初始化或循环调用用到的功能。 |
| `HLIBC_NO_IMPLEMENTATION`       | 不实现[hlibc](hlibc) | 可用于在编译器垃圾回收不完善时减少资源占用,将强制启用`HDEFAULTS_LIBC_TINY`。 |

## `HDEFAULTS_LIBC_OPTIMIZE_LEVEL`

此项配置为用于对包装的C运行库库函数进行优化，默认仅可定义为数字。

| 级别 |                                                              |
| ---- | ------------------------------------------------------------ |
| 0    | 直接包装C运行库函数                                          |
| 1    | 新的C运行库包装函数将尽量使用已包装的C运行库函数实现，如需额外实现则采用[hlibc](hlibc)中的实现或者调用包装的系统调用。 |

# C运行库

## stdio

### `putchar`

将字符输出到标准输出上。

可外部配置的宏定义如下:

| 宏定义     | 说明                | 备注                     |
| ---------- | ------------------- | ------------------------ |
| `HPUTCHAR` | 用户实现的`putchar` | 参数与返回值同`hputchar` |

### `getchar`

从标准输入上读取字符。

可外部配置的宏定义如下:

| 宏定义     | 说明                | 备注                     |
| ---------- | ------------------- | ------------------------ |
| `HGETCHAR` | 用户实现的`getchar` | 参数与返回值同`hgetchar` |

### `fputs`

向文件输出字符串。

可外部配置的宏定义如下:

| 宏定义   | 说明              | 备注                   |
| -------- | ----------------- | ---------------------- |
| `HFPUTS` | 用户实现的`fputs` | 参数与返回值同`hfputs` |

### `vfprintf`

向文件输出字符串(格式化输出)。

可外部配置的宏定义如下:

| 宏定义      | 说明                 | 备注                      |
| ----------- | -------------------- | ------------------------- |
| `HVFPRINTF` | 用户实现的`vfprintf` | 参数与返回值同`hvfprintf` |

### `fprintf`

向文件输出字符串(格式化输出)。

**注意：默认采用`vfprintf`实现。**

### `puts`

输出字符串。

可外部配置的宏定义如下:

| 宏定义  | 说明             | 备注                  |
| ------- | ---------------- | --------------------- |
| `HPUTS` | 用户实现的`puts` | 参数与返回值同`hputs` |

### `ferror`

获取文件错误

可外部配置的宏定义如下:

| 宏定义    | 说明               | 备注                    |
| --------- | ------------------ | ----------------------- |
| `HFERROR` | 用户实现的`ferror` | 参数与返回值同`hferror` |

### `fread`

读取文件

可外部配置的宏定义如下:

| 宏定义   | 说明              | 备注                   |
| -------- | ----------------- | ---------------------- |
| `HFREAD` | 用户实现的`fread` | 参数与返回值同`hfread` |

### `fwrite`

写入文件

可外部配置的宏定义如下:

| 宏定义    | 说明               | 备注                    |
| --------- | ------------------ | ----------------------- |
| `HFWRITE` | 用户实现的`fwrite` | 参数与返回值同`hfwrite` |

## stdlib

### `getenv`

获取环境变量。

除了通过启动应用时的命令传递参数外，也可通过环境变量传递参数。

可外部配置的宏定义如下:

| 宏定义    | 说明               | 备注                    |
| --------- | ------------------ | ----------------------- |
| `HGETENV` | 用户实现的`getenv` | 参数与返回值同`hgetenv` |

### `malloc`

内存分配

注意：内存相关配置不在libc包装中做，而在hdefaults组件。

### `free`

内存释放

注意：内存相关配置不在libc包装中做，而在hdefaults组件。

### `calloc`

内存分配（初始化为0）

注意：内存相关配置不在libc包装中做，而在hdefaults组件。

### `realloc`

内存重新分配。

注意：内存相关配置不在libc包装中做，而在hdefaults组件。

### `abort`

通过Abort信号退出程序

可外部配置的宏定义如下:

| 宏定义   | 说明              | 备注                   |
| -------- | ----------------- | ---------------------- |
| `HABORT` | 用户实现的`abort` | 参数与返回值同`habort` |

### `exit`

在主线程退出程序（将执行清理代码）

可外部配置的宏定义如下:

| 宏定义  | 说明             | 备注                  |
| ------- | ---------------- | --------------------- |
| `HEXIT` | 用户实现的`exit` | 参数与返回值同`hexit` |

## time

### `time`

获取当前日历时间

可外部配置的宏定义如下:

| 宏定义  | 说明             | 备注                  |
| ------- | ---------------- | --------------------- |
| `HTIME` | 用户实现的`time` | 参数与返回值同`htime` |

### `clock`

获取当前处理器时间(类似节拍)

可外部配置的宏定义如下:

| 宏定义   | 说明              | 备注                   |
| -------- | ----------------- | ---------------------- |
| `HCLOCK` | 用户实现的`clock` | 参数与返回值同`hclock` |

## string

### `strcmp`

字符串比较

可外部配置的宏定义如下:

| 宏定义                       | 说明               | 备注                                                        |
| ---------------------------- | ------------------ | ----------------------------------------------------------- |
| `HSTRCMP`                    | 用户实现的`strcmp` | 参数与返回值同`hstrcmp`                                     |
| `HDEFAULTS_LIBC_TINY_STRCMP` | 采用精简版strcmp   | 某些工具链的C库可能有问题，可启用此选项使用内置精简版strcmp |

### `strncmp`

字符串比较指定长度字符

可外部配置的宏定义如下:

| 宏定义                        | 说明                | 备注                                                         |
| ----------------------------- | ------------------- | ------------------------------------------------------------ |
| `HSTRNCMP`                    | 用户实现的`strncmp` | 参数与返回值同`hstrncmp`                                     |
| `HDEFAULTS_LIBC_TINY_STRNCMP` | 采用精简版strncmp   | 某些工具链的C库可能有问题，可启用此选项使用内置精简版strncmp |

### `strlen`

获取以NULL结尾的字符串的长度

可外部配置的宏定义如下:

| 宏定义                       | 说明               | 备注                                                        |
| ---------------------------- | ------------------ | ----------------------------------------------------------- |
| `HSTRLEN`                    | 用户实现的`strlen` | 参数与返回值同`hstrlen`                                     |
| `HDEFAULTS_LIBC_TINY_STRLEN` | 采用精简版strlen   | 某些工具链的C库可能有问题，可启用此选项使用内置精简版strlen |

### `memset`

填充内存

可外部配置的宏定义如下:

| 宏定义                       | 说明               | 备注                                                        |
| ---------------------------- | ------------------ | ----------------------------------------------------------- |
| `HMEMSET`                    | 用户实现的`memset` | 参数与返回值同`hmemset`                                     |
| `HDEFAULTS_LIBC_TINY_MEMSET` | 采用精简版memset   | 某些工具链的C库可能有问题，可启用此选项使用内置精简版memset |

## stdatomic

### atomic_flag

原子标志。

可外部配置的宏定义如下:

| 宏定义                               | 说明                         | 备注                                                         |
| ------------------------------------ | ---------------------------- | ------------------------------------------------------------ |
| `HATOMIC_FLAG`                       | 原子标志结构体               | 注意:如需使用则需要同时定义`HATOMIC_FLAG_INIT`用于初始化结构体。 |
| `HATOMIC_FLAG_TEST_AND_SET_EXPLICIT` | 用户实现的原子标志测试与设置 | 参数与返回值同`hatomic_flag_test_and_set_explicit`           |
| `HATOMIC_FLAG_CLEAR_EXPLICIT`        | 用户实现的原子标志清除       | 参数与返回值同`hatomic_flag_clear_explicit`                  |

## threads

### thrd

线程。

注意：

- 某些平台可能不可用。

可外部配置的宏定义如下:

| 宏定义                      | 说明                                       | 备注                                                         |
| --------------------------- | ------------------------------------------ | ------------------------------------------------------------ |
| `HTHRD_SIZE`                | 管理线程的结构体大小，单位为指针大小的倍数 | 不可小于1                                                    |
| `HTHRD_CREATE`              | 用户实现的线程创建                         | 参数与返回值同`hthrd_create`                                 |
| `HTHRD_EQUAL`               | 用户实现的线程比较                         | 参数与返回值同`hthrd_equal`                                  |
| `HTHRD_CURRENT`             | 用户实现的当前线程获取                     | 参数与返回值同`hthrd_current`                                |
| `HTHRD_SLEEP`               | 用户实现的线程睡眠                         | 参数与返回值同`hthrd_sleep`                                  |
| `HTHRD_YIELD`               | 用户实现的让出事件片                       | 参数与返回值同`hthrd_yield`                                  |
| `HTHRD_EXIT`                | 用户实现的线程退出                         | 参数与返回值同`hthrd_exit`                                   |
| `HTHRD_DETACH`              | 用户实现的线程detach                       | 参数与返回值同`hthrd_detach`                                 |
| `HTHRD_JOIN`                | 用户实现的线程join                         | 参数与返回值同`hthrd_join`                                   |
| `HTHRD_USING_PTHREAD`       | 允许在非unix(类unix)平台使用pthread        | 一般用于某些兼容pthread的环境                                |
| `NANOSLEEP`                 | 用户实现的`nanosleep`                      | 用于`pthread`移植，参数与返回值同`nanosleep`                 |
| `HTHRD_USING_FREERTOS`      | 允许使用`FreeRTOS`内核                     | 用于嵌入式环境，用户需要在配置文件中包含`FreeRTOS.h`与`task.h` |
| `HTHRD_FREERTOS_STACK_SIZE` | `FreeRTOS`默认栈大小                       |                                                              |
| `HTHRD_FREERTOS_PRIORITY`   | `FreeRTOS`默认优先级                       |                                                              |
| `HTHRD_FREERTOS_NAME`       | `FreeRTOS`默认任务名称                     |                                                              |

### call_once

函数调用一次。

可外部配置的宏定义如下:

| 宏定义            | 说明                                          | 备注                                                         |
| ----------------- | --------------------------------------------- | ------------------------------------------------------------ |
| `HCALL_ONCE_SIZE` | `once_flag`的结构体大小，单位为指针大小的倍数 | 不可小于1.理论上只需要一个字节，但某些实现采用4字节，故仍然采用指针大小作为基本单位。 |
| `HCALL_ONCE`      | 用户实现的`call_once`.                        | 参数与返回值同`hcall_once`                                   |

### mtx

互斥锁

注意：

- 某些平台可能不可用。

可外部配置的宏定义如下:

| 宏定义           | 说明                                         | 备注                                                         |
| ---------------- | -------------------------------------------- | ------------------------------------------------------------ |
| `HMTX_SIZE`      | 管理互斥锁的结构体大小，单位为指针大小的倍数 | 不可小于1                                                    |
| `HMTX_INIT`      | 用户实现的互斥锁初始化                       | 参数与返回值同`hmtx_init`                                    |
| `HMTX_LOCK`      | 用户实现的互斥锁加锁                         | 参数与返回值同`hmtx_lock`                                    |
| `HMTX_TIMEDLOCK` | 用户实现的带时间的互斥锁加锁                 | 参数与返回值同`hmtx_timedlock`，时间采用实时时间而非单调时间 |
| `HMTX_TRYLOCK`   | 用户实现的互斥锁尝试加锁                     | 参数与返回值同`hmtx_trylock`                                 |
| `HMTX_UNLOCK`    | 用户实现的互斥锁解锁                         | 参数与返回值同`hmtx_unlock`                                  |
| `HMTX_DESTROY`   | 用户实现的互斥锁销毁                         | 参数与返回值同`hmtx_destroy`                                 |

# posix标准

某些函数不属于C标准，但属于posix标准，也在此目录包装。

## stdlib

### `setenv`

设置环境变量。

可外部配置的宏定义如下:

| 宏定义    | 说明               | 备注                    |
| --------- | ------------------ | ----------------------- |
| `HSETENV` | 用户实现的`setenv` | 参数与返回值同`hsetenv` |

### `unsetenv`

设置环境变量。

可外部配置的宏定义如下:

| 宏定义      | 说明                 | 备注                      |
| ----------- | -------------------- | ------------------------- |
| `HUNSETENV` | 用户实现的`unsetenv` | 参数与返回值同`hunsetenv` |

# 非标实现

C标准库的某些代码需要编译器实现且无法通过较老标准的C代码实现，故而转为非标实现。

## stdatmoic

### atomic_int

整型原子变量操作。

注意：

- 为确保对整型变量进行原子操作,不可对变量进行直接访问，而应当使用函数访问。

# 参考资源

- [https://www.cppreference.com/](https://www.cppreference.com/)
- [https://pubs.opengroup.org/onlinepubs/9699919799/](https://pubs.opengroup.org/onlinepubs/9699919799/)

